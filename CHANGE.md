# Change Log

## [1.10] 2025-06-13

### 주요 변경 사항

#### 1. StopTransaction(충전 종료) 이후 PWM duty 3% 적용
- StopTransaction(충전 종료) 이후, Control Pilot(CP) 라인에 출력되는 PWM duty를 기존 100%에서 3%로 낮추도록 변경하였습니다.
- **기술적 배경:**
  - J1772 표준 및 실차 테스트 결과, 대부분의 전기차는 CP duty가 3% 이하일 때 ECU(12V 시스템)가 슬립 모드로 진입하여 방전이 방지됩니다.
  - 이 변경으로 충전 종료 후에도 커넥터 연결 감지는 유지하면서, 차량 12V 배터리 방전 문제를 해결할 수 있습니다.

#### 2. 충전 종료 후 10분 경과 시 CP 릴레이 차단(회로 단선)
- StopTransaction 이후 10분(600초) 동안은 CP 연결을 유지하며, 이후에도 커넥터가 계속 연결되어 있으면 CP 릴레이를 차단(:close)하여 회로적으로 완전히 단선되도록 하였습니다.
- StopTransaction(충전 종료) 이후 10분이 경과하면 CP 릴레이를 차단(close)하여 회로적으로 단선되도록 하였습니다.
- **기술적 배경:**
  - 일부 차량은 PWM duty 3% 상태에서도 ECU가 슬립하지 않고 방전이 계속될 수 있습니다.
  - 10분 후 CP를 물리적으로 차단하면, 차량은 충전기가 완전히 분리된 것으로 인식하여 ECU가 강제로 종료됩니다.
  - 단, 이 경우 충전기 소프트웨어에서는 커넥터 연결 감지가 불가능해지므로, 기본 동작은 duty 3% 유지, 예외적으로 방전 지속 시에만 회로 차단이 동작합니다.
  - CP 릴레이 차단은 차량이 완전히 분리된 것과 동일하게 인식됩니다.
   (단, 이때는 실제 커넥터가 뽑힌 것인지, 릴레이만 차단된 것인지는 소프트웨어적으로 구분하지 못합니다.)


#### 3. run_mode_a(일반 충전 모드)에서 차량 분리 시 PWM duty 0% 처리 로직 추가
- run_mode_a(일반 충전 모드)에서 차량이 분리되어 충전기가 완전히 대기(Available) 상태로 전환될 때, J1772 표준에 따라 CP(Control Pilot) 라인의 PWM 신호 출력을 완전히 꺼주도록 duty_cycle을 0으로 설정하는 코드를 추가하였습니다.
- **기술적 배경:**
  - J1772 표준에서는 차량이 분리된 상태(Available, 상태 A)에서는 CP 라인에 PWM 신호가 필요 없습니다.
  - 이 변경으로 하드웨어 오동작, 불필요한 전력 소모, 예기치 않은 상태 전이 등을 방지할 수 있습니다.
  - 충전기와 차량 모두 명확하게 "연결 없음" 상태로 인식할 수 있습니다.
- **실무적 효과:**
  - 표준 준수, 하드웨어 보호, 오동작 방지, 명확한 상태 전이 보장

#### 4. 기타
- 위 변경 사항은 onflex.rb의 StopTransaction(충전 종료) 처리 로직에 반영되었습니다.
- 실차 테스트를 통해 차량별 반응을 반드시 확인할 것을 권장합니다.

--- 